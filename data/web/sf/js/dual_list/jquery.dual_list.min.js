(function(b){var k=function(a,c){this.$element=b(a);this.options=b.extend(!0,{},b.fn.dualList.defaults,c);this.$associated=this.$element.find(this.getClassName("associated",!0));this.$available=this.$element.find(this.getClassName("available",!0));this.$availableList=this.$available.find(this.getClassName("items",!0)+" ul");this.$associatedList=this.$associated.find(this.getClassName("items",!0)+" ul");this.$moveToAssociated=this.$element.find(this.getClassName("move-associated",!0));this.$moveToAvailable=
this.$element.find(this.getClassName("move-available",!0));this.$selectAllButton=this.$element.find(this.getClassName("select-all",!0));this.$unSelectAllButton=this.$element.find(this.getClassName("unselect-all",!0));this.$invertSelectionButton=this.$element.find(this.getClassName("invert-selection",!0));this.$associatedFilterInput=this.$associated.find(this.getClassName("filters",!0)+' input[type="text"]');this.$availableFilterInput=this.$available.find(this.getClassName("filters",!0)+' input[type="text"]');
this.$associatedFilterButton=this.$associated.find(this.getClassName("filters",!0)+" :button");this.$availableFilterButton=this.$available.find(this.getClassName("filters",!0)+" :button");this.options.resizableEnabled&&this.setupResizable();this.setupEvents();this.setupListItems()},l={standard:function(a,c){return a>c?1:a<c?-1:0},alphabetical:function(a,c){return b(a).text().toUpperCase().localeCompare(b(c).text().toUpperCase())},position:function(a,c){return l.standard(b(a).data("position"),b(c).data("position"))}};
k.prototype={constructor:k,timers:[],getClassName:function(a,c){return c?"."+this.options.baseClass+"-"+a:this.options.baseClass+"-"+a},setupEvents:function(){this.$element.on("associated_added.dual_list",b.proxy(this.handleAssociatedAdded,this));this.$element.on("associated_removed.dual_list",b.proxy(this.handleAssociatedRemoved,this));this.$moveToAssociated.on("click",b.proxy(this.moveToAssociatedClicked,this,this.$moveToAssociated));this.$moveToAvailable.on("click",b.proxy(this.moveToAvailableClicked,
this,this.$moveToAvailable));this.$associatedFilterInput.on("keypress",b.proxy(this.handleFilterInputKeyPressed,this,this.$associatedFilterInput,this.$associatedList)).on("keyup",b.proxy(this.handleFilterInputKeyUp,this,this.$associatedFilterInput,this.$associatedList));this.$availableFilterInput.on("keypress",b.proxy(this.handleFilterInputKeyPressed,this,this.$availableFilterInput,this.$availableList)).on("keyup",b.proxy(this.handleFilterInputKeyUp,this,this.$availableFilterInput,this.$availableList));
this.$availableFilterButton.on("click",b.proxy(this.handleFilterButtonClicked,this,this.$availableFilterInput,this.$availableList));this.$associatedFilterButton.on("click",b.proxy(this.handleFilterButtonClicked,this,this.$associatedFilterInput,this.$associatedList));this.$selectAllButton.on("click",b.proxy(this.handleSelectAllButtonClicked,this));this.$unSelectAllButton.on("click",b.proxy(this.handleUnSelectAllButtonClicked,this));this.$invertSelectionButton.on("click",b.proxy(this.handleInvertSelectionButtonClicked,
this))},handleFilterButtonClicked:function(a,c){a.val("").trigger("change");this.filterList(a,c);this.updateCounts()},handleFilterInputKeyPressed:function(a,c,b){13===b.keyCode&&e.preventDefault()},handleFilterInputKeyUp:function(a,c){this.filterList(a,c);this.updateCounts()},filterList:function(a,c){var f=c.children("li"),d=f.map(function(){var a=b(this),c=a.prop("title");return c?c.toLowerCase():a.text().toLowerCase()}),g=b.trim(a.val().toLowerCase()),h=[];g?(f.hide(),d.each(function(a){-1<this.indexOf(g)&&
h.push(a)}),b.each(h,function(){b(f[this]).show()})):f.show()},handleSelectAllButtonClicked:function(a){var c=this;b(a.target).parents(this.getClassName("header",!0)+":first").parent().find(this.getClassName("items",!0)+" ul li:visible").each(function(){b(this).addClass(c.options.selectedClass)});a.preventDefault()},handleUnSelectAllButtonClicked:function(a){var c=this;b(a.target).parents(this.getClassName("header",!0)+":first").parent().find(this.getClassName("items",!0)+" ul li:visible").each(function(){b(this).removeClass(c.options.selectedClass)});
a.preventDefault()},handleInvertSelectionButtonClicked:function(a){var c=this;b(a.target).parents(this.getClassName("header",!0)+":first").parent().find(this.getClassName("items",!0)+" ul li:visible").each(function(){b(this).toggleClass(c.options.selectedClass)});a.preventDefault()},handleAssociatedAdded:function(a,c){this.updateCounts()},handleAssociatedRemoved:function(a,c,b){b||this.sortAvailableList()},getComparator:function(){return this.options.sortMethod?"function"===typeof this.options.sortMethod?
this.options.sortMethod:l[this.options.sortMethod]:null},sortAvailableList:function(){var a=this.$availableList.children("li"),c=this.getComparator();c&&(a.sort(c),this._updateSort(0,a))},_updateSort:function(a,c){var b,d=Math.min(a+this.options.batchSize,c.length);0===a&&("undefined"!==typeof this.timers.sort_available&&(clearTimeout(this.timers.sort_available),delete this.timers.sort_available),this.$available.addClass("loading"));for(b=a;b<d;b++)this.$availableList.append(c[b]);var g=this;d<c.length?
this.timers.sort_available=setTimeout(function(){g._updateSort(d,c)},0):(delete this.timers.sort_available,this.$available.removeClass("loading"),this.updateCounts())},updateCounts:function(){var a=this.$associatedList.children("li"),c=this.$availableList.children("li"),b=a.length,d=a.filter(":hidden").length,a=c.length,c=c.filter(":hidden").length,g=b;d&&(g=b-d+" / "+b);b=a;c&&(b=a-c+" / "+a);this.$element.find(this.getClassName("associated-count",!0)).text(g);this.$element.find(this.getClassName("available-count",
!0)).text(b)},setupResizable:function(){var a=this.options.resizable;!1===a.minHeight&&(a.minHeight=this.$available.find(this.getClassName("items",!0)).outerHeight());this.$available.find(this.getClassName("items",!0)).resizable(b.extend({},a,{handles:{s:this.$available.find(this.getClassName("resizable-handle",!0))},alsoResize:this.$associated.find(this.getClassName("items",!0))}));this.$associated.find(this.getClassName("items",!0)).resizable(b.extend({},a,{handles:{s:this.$associated.find(this.getClassName("resizable-handle",
!0))},alsoResize:this.$available.find(this.getClassName("items",!0))}))},moveToAvailableClicked:function(a,c){var b=this.$associatedList.find("."+this.options.selectedClass);b.length&&this.moveToAvailable(b)},moveToAssociatedClicked:function(a,c){var b=this.$availableList.find("."+this.options.selectedClass);b.length&&this.moveToAssociated(b)},moveToAvailable:function(a,b){this._moveTo(0,a,!1)},moveToAssociated:function(a){this._moveTo(0,a,!0)},_moveTo:function(a,c,f){var d=c.length,g=Math.min(a+
this.options.batchSize,d),h="move_to"+(f?"_associated":"_available");0===a&&("undefined"!==typeof this.timers[h]&&(clearTimeout(this.timers[h]),delete this.timers[h]),d>this.options.batchSize&&(this.$associated.addClass("loading"),this.$available.addClass("loading")));for(;a<g;a++)f?(this.$associatedList.append(c[a]),this.markAsAssociated(b(c[a]))):(this.$availableList.append(c[a]),this.markAsAvailable(b(c[a])));var k=this;g<c.length?this.timers[h]=setTimeout(function(){k._moveTo(g,c,f)},0):(delete this.timers[h],
d>this.options.batchSize&&(this.$associated.removeClass("loading"),this.$available.removeClass("loading")),f?this.$element.trigger("associated_added.dual_list",[c]):this.$element.trigger("associated_removed.dual_list",[c]))},markAsAssociated:function(a){a.data("associated",!0).removeClass(this.options.selectedClass);a.find("input:checkbox").prop("checked",!0).trigger("change")},markAsAvailable:function(a){a.removeData("associated").removeClass(this.options.selectedClass);a.find("input:checkbox").prop("checked",
!1).trigger("change")},getItemExchangeButton:function(){return b('<button type="button" class="'+this.options.buttons.exchangeClass+" "+this.getClassName("item-toggle")+'"><i class="'+this.options.icons.itemExchange+'"></i></button>')},handleItemExchangeButtonClicked:function(a){var c=b(a.target).parents("li:first");this.moveItem(c);a.stopPropagation();a.preventDefault()},getSortableHandle:function(){return b('<div class="'+this.getClassName("sortable-handle")+'"><i class="'+this.options.icons.itemSort+
'"></i></div>')},handleItemClicked:function(a,b){a.toggleClass(this.options.selectedClass)},moveItem:function(a){a.data("associated")?this.moveToAvailable(a):this.moveToAssociated(a)},setupItemEvents:function(a){a.on("click.dual_list",b.proxy(this.handleItemClicked,this,a))},_setupItems:function(a,c,f){var d=c.length,g=Math.min(a+this.options.batchSize,d),h="setup_items"+(f?"_associated":"_available");if(0!==d){"undefined"===typeof this.button&&(this.button=this.getItemExchangeButton());this.options.sortableEnabled&&
"undefined"===typeof this.sortableHandle&&(this.sortableHandle=this.getSortableHandle());for(;a<g;a++)d=b(c[a]),f&&this.markAsAssociated(d),this.button.clone().on("click",b.proxy(this.handleItemExchangeButtonClicked,this)).appendTo(d),this.options.sortableEnabled&&this.sortableHandle.clone().prependTo(d),this.setupItemEvents(d);var k=this;g<c.length?this.timers[h]=window.setTimeout(function(){k._setupItems(g,c,f)},0):(delete this.timers[h],f||(delete this.button,delete this.sortableHandle))}},setupListItems:function(){if(this.options.sortableEnabled){var a=
b.extend({},{handle:this.getClassName("sortable-handle",!0),axis:"y",appendTo:document.body,cursor:"move",forceHelperSize:!0,placeholder:this.getClassName("sortable-placeholder")},this.options.sortable);this.$associatedList.sortable(a)}this.$availableList.disableSelection();this.$associatedList.disableSelection();this._setupItems(0,this.$availableList.children("li"),!1);this._setupItems(0,this.$associatedList.children("li"),!0)}};b.fn.dualList=function(a){return this.each(function(){var c=b(this),
f=c.data("dualList"),d="object"===typeof a&&a;f||c.data("dualList",f=new k(this,d));if("string"===typeof a)f[a]()})};b.fn.dualList.defaults={sortableEnabled:!0,sortable:{},batchSize:100,buttons:{exchangeClass:"btn btn-mini"},sortMethod:"position",icons:{itemExchange:"icon-exchange",itemSort:"icon-sort"},resizableEnabled:!0,resizable:{minHeight:!1},selectedClass:"selected",baseClass:"dual-list"};b.fn.dualList.Constructor=k})(window.jQuery);
